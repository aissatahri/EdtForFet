<div class="container mt-2">
  <!-- <h2>{{ 'ELEVE.LIST_TITLE' | translate }}</h2> -->
  <div class="mb-3">
    <a
      routerLink="/dash/elevenote/"
      class="btn btn-secondary"
      (click)="onNotesClick()"
    >
      {{ "ELEVE.DATER_DEVOIRS" | translate }}
    </a>
  </div>
  <form [formGroup]="formGroup">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">{{ "SEARCH.CRITERIA" | translate }}</h5>
        <button
          class="btn btn-custom"
          type="button"
          (click)="togglePanel('panelContent6')"
        >
          <span class="toggle-sign">{{
            isPanelOpen("panelContent6") ? "-" : "+"
          }}</span>
        </button>
      </div>
      <div
        id="panelContent6"
        class="collapse"
        [ngClass]="{ show: isPanelOpen('panelContent6') }"
      >
        <div class="card-body">
          <div class="row mb-3">
            <!-- Sélection du Niveau -->
            <div class="col-md-6 form-group">
              <label for="niveau">{{
                "SEARCH.SELECT_LEVEL" | translate
              }}</label>
              <select
                id="niveau"
                class="form-control"
                formControlName="niveau"
                (change)="onNiveauChange($event)"
              >
                <option value="">
                  -- {{ "SEARCH.CHOOSE_LEVEL" | translate }} --
                </option>
                <option
                  *ngFor="let niveau of niveaux$ | async"
                  [value]="niveau.idNiveau"
                >
                  {{ niveau.libelle }}
                </option>
              </select>
            </div>
            <!-- Sélection de la Classe -->
            <div class="col-md-6 form-group">
              <label for="classe">{{
                "SEARCH.SELECT_CLASS" | translate
              }}</label>
              <select
                id="classeSelect"
                class="form-control"
                formControlName="classe"
                (change)="onClasseChange($event)"
              >
                <option value="">
                  -- {{ "SEARCH.CHOOSE_CLASS" | translate }} --
                </option>
                <option
                  *ngFor="let classe of classes"
                  [value]="classe.idClasse"
                >
                  {{ classe.libelle }}
                </option>
              </select>
            </div>
            <!-- Sélection de la SousClasse -->
            <div *ngIf="hasSousClasses" class="col-md-6 form-group">
              <label for="sousClasse">{{
                "SEARCH.SELECT_SUBCLASS" | translate
              }}</label>
              <select
                class="form-control"
                id="sousClasseSelect"
                formControlName="sousClasse"
                (change)="onSousClasseChange($event)"
              >
                <option value="">
                  -- {{ "SEARCH.CHOOSE_SUBCLASS" | translate }} --
                </option>
                <option
                  *ngFor="let sousClasse of sousClasses"
                  [value]="sousClasse.idSousClasse"
                >
                  {{ sousClasse.libelle }}
                </option>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <!-- Sélection de la Période -->
            <div class="col-md-6 form-group">
              <label for="periode">{{
                "SEARCH.SELECT_PERIOD" | translate
              }}</label>
              <select
                id="periodeSelect"
                class="form-control"
                formControlName="periode"
                (change)="onPeriodeChange($event)"
              >
                <option value="">
                  -- {{ "SEARCH.CHOOSE_PERIOD" | translate }} --
                </option>
                <option
                  *ngFor="let periode of periodes"
                  [value]="periode.idPeriode"
                >
                  {{ periode.libelle }}
                </option>
              </select>
            </div>

            <!-- Sélection de Devoir -->
            <div class="col-md-6 form-group">
              <label for="devoir">{{
                "SEARCH.SELECT_HOMEWORK" | translate
              }}</label>
              <select
                id="devoirSelect"
                class="form-control"
                formControlName="devoir"
                (change)="onDevoirChange($event)"
              >
                <option value="">
                  -- {{ "SEARCH.CHOOSE_HOMEWORK" | translate }} --
                </option>
                <option value="*">
                  {{ "*" | translate }}
                </option>
                <option
                  *ngFor="let devoir of devoirs"
                  [value]="devoir.idDevoir"
                >
                  {{ devoir.libelle }}
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Formulaire pour les notes -->
<div class="container mt-2">
  <form [formGroup]="formGroup">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">{{ "NOTES.TITLE" | translate }}</h5>
        <button
          class="btn btn-custom"
          type="button"
          (click)="togglePanel('panelContent7')"
        >
          <span class="toggle-sign">{{
            isPanelOpen("panelContent7") ? "-" : "+"
          }}</span>
        </button>
      </div>
      <div
        id="panelContent7"
        class="collapse"
        [ngClass]="{ show: isPanelOpen('panelContent7') }"
      >
        <div class="card-body">
          <div *ngIf="selectedDevoirId === null">
            <!-- Tableau pour l'affichage de tous les devoirs -->
            <table class="table table-striped table-bordered table-hover">
              <thead class="table-dark">
                <tr>
                  <th>{{ "NOTES.STUDENT_NUMBER" | translate }}</th>
                  <th>{{ "NOTES.STUDENT_NAME" | translate }}</th>
                  <th *ngFor="let devoir of devoirs">{{ devoir.libelle }}</th>
                  <th>Moyenne</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let eleveDevoirs of eleveDevoirsGrouped; let i = index; trackBy: trackByEleveDevoirs">
                  <td>{{ eleveDevoirs[0].eleve?.num }}</td>
                  <td>{{ eleveDevoirs[0].eleve?.nom }}</td>
                  <td *ngFor="let devoir of devoirs">
                    {{ getNoteForDevoir(eleveDevoirs[0], devoir) }}
                  </td>
                  <!-- <td>{{devoir.idDevoir}}</td> -->
                  <td>{{ calculateFinalNoteForStudent(eleveDevoirs) }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div *ngIf="selectedDevoirId !== null">
            <!-- Tableau pour l'affichage d'un devoir spécifique -->
            <table class="table table-striped table-bordered table-hover">
              <thead class="table-dark">
                <tr>
                  <th>{{ "NOTES.STUDENT_NUMBER" | translate }}</th>
                  <th>{{ "NOTES.CODE" | translate }}</th>
                  <th>{{ "NOTES.STUDENT_NAME" | translate }}</th>
                  <th>{{ "NOTES.BIRTH_DATE" | translate }}</th>
                  <th>{{ "NOTES.HOMEWORK" | translate }}</th>
                  <th>{{ "NOTES.GRADE" | translate }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let eleveDevoir of getPaginatedClasseEleves(); let i = index; trackBy: trackByEleveDevoir">
                  <td>{{ eleveDevoir.eleve?.num }}</td>
                  <td>{{ eleveDevoir.eleve?.code }}</td>
                  <td>{{ eleveDevoir.eleve?.nom }}</td>
                  <td>{{ eleveDevoir.eleve?.dateNaissance }}</td>
                  <td>{{ eleveDevoir.devoir?.libelle }}</td>
                  <td>
                    <input
                      type="number"
                      class="form-control text-center"
                      [value]="eleveDevoir.note === null ? '' : eleveDevoir.note"
                      (input)="onNoteChange($event, eleveDevoir)"
                      min="0"
                      max="20"
                      step="0.01"
                      required
                    />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <nav>
            <ul class="pagination justify-content-center">
              <!-- Précédent -->
              <li class="page-item" [class.disabled]="page === 1">
                <a
                  class="page-link"
                  href="#"
                  (click)="previousPage(); $event.preventDefault()"
                >
                  {{ "NOTES.PREVIOUS" | translate }}
                </a>
              </li>
              <!-- Suivant -->
              <li class="page-item" [class.disabled]="page === totalPages">
                <a
                  class="page-link"
                  href="#"
                  (click)="nextPage(); $event.preventDefault()"
                >
                  {{ "NOTES.NEXT" | translate }}
                </a>
              </li>
            </ul>
          </nav>
          <div class="button-container">
            <!-- Bouton Enregistrer -->
            <button
              class="btn btn-primary mt-3 me-2"
              type="button"
              (click)="enregistrerNotes()"
            >
              <i class="fas fa-save"></i>
              {{ "NOTES.SAVE" | translate }}
            </button>

            <!-- Bouton Imprimer -->
            <button
              class="btn btn-success mt-3 me-2"
              type="button"
              (click)="imprimer()"
            >
              <i class="fas fa-print"></i>
              {{ "NOTES.PRINT_PDF" | translate }}
            </button>

            <!-- Un seul bouton pour sélectionner et envoyer le fichier -->
            <button
              class="btn btn-primary mt-3 me-2"
              type="button"
              (click)="triggerFileSelectionAndSubmit(fileInput)"
            >
              <i class="fas fa-file-upload"></i>
              {{ "NOTES.EXPORT_MASSAR" | translate }}
            </button>

            <!-- Champ de sélection de fichier masqué -->
            <input
              #fileInput
              type="file"
              style="display: none"
              (change)="onFileChangeAndSubmit($event)"
              accept=".xlsx"
            />
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Modal de succès -->
<div class="modal" #successModal>
  <div class="modal-content">
    <span class="close" (click)="closeSuccessModal()" class="close-button">&times;</span>
    <h2 class="modal-title">{{ "MODAL.SUCCESS" | translate }}</h2>
    <p class="modal-message">{{ successMessage }}</p>
    <button (click)="closeSuccessModal()" class="modal-button">{{'STUDENT.CLOSE'|translate}}</button>
  </div>
</div>

